# rootfs-rltv-cnv —— 并行修复符号链接工具

## 概述

`rootfs-rltv-cnv` 用于**批量扫描并修复目录树中的符号链接**，主要解决以下问题：

1. 将**以 `/` 开头的链接目标**视为「**相对于给定 ROOT_DIR 的绝对路径**」，并**转换为相对路径**
2. **删除悬空符号链接**
3. 支持 **并行处理**，在大规模目录（如 rootfs / sysroot）中速度显著提升
4. 提供 **实时进度条**
5. 输出 **统计结果**（删除 / 转换 / 跳过）

该脚本适合用于：

* rootfs 重定位
* 交叉编译 sysroot 修复
* chroot / 容器镜像整理
* SDK / 工具链打包前清洗

---

## 行为定义（非常重要）

### 1️⃣ 符号链接分类规则

对 `ROOT_DIR` 下的每一个符号链接 `link`：

| 情况   | 判定                    | 行为      |
| ---- | --------------------- | ------- |
| 悬空链接 | 链接最终指向的文件不存在          | 删除      |
| 绝对链接 | `readlink` 结果以 `/` 开头 | 转换为相对路径 |
| 其他   | 已是相对路径或无需修改           | 跳过      |

---

### 2️⃣ “绝对路径”的特殊语义

> ⚠️ 本脚本 **不会** 将 `/xxx` 视为系统根 `/`

而是：

```text
link -> /usr/lib/libfoo.so
```

被解释为：

```text
link -> ROOT_DIR/usr/lib/libfoo.so
```

这是为了支持 **rootfs / sysroot 场景**。

---

### 3️⃣ 相对路径计算方式

* 优先使用 `realpath --relative-to`
* 若不存在，则回退到 `python3 os.path.relpath`
* 若两者都不可用 → 直接报错退出

---

## 使用方法

### 基本用法

```bash
./rootfs-rltv-cnv ROOT_DIR
```

---

### 预演（不修改文件）

```bash
./rootfs-rltv-cnv ROOT_DIR --dry-run --verbose
```

---

### 指定并行度

```bash
./rootfs-rltv-cnv ROOT_DIR --jobs 4
```

默认并行数：

```text
--jobs = nproc
```

---

## 参数说明

| 参数           | 说明                |
| ------------ | ----------------- |
| `ROOT_DIR`   | 要扫描的根目录（必填）       |
| `--jobs N`   | 并行任务数（默认 `nproc`） |
| `--dry-run`  | 只打印将执行的命令，不修改文件   |
| `--verbose`  | 打印每个删除 / 转换操作     |
| `-h, --help` | 显示帮助              |

---

## 进度条机制

### 实现方式

```text
find → pv → xargs -P
```

* 使用 `pv -l` 按“链接数量”显示进度
* 自动显示：

  * 已处理数
  * 百分比
  * ETA
* **仅在 stdout 是 TTY 且 pv 可用时启用**

### 无 pv / 非交互场景

* 自动退化为普通管道
* 适用于 CI / 重定向输出

---

## 并行模型

### 架构

```text
父进程
 ├─ find 统计总数
 ├─ find | pv | xargs -P
 │    ├─ 子进程 1：处理一个 symlink
 │    ├─ 子进程 2
 │    └─ 子进程 N
 └─ 汇总统计结果
```

### 并行安全性

* 每个符号链接 **只被一个进程处理**
* `rm -f` / `ln -snf` 为原子操作
* 无共享可变内存
* 无锁主路径（仅统计时使用文件系统）

---

## 统计结果说明

### 统计项

| 项目      | 含义           |
| ------- | ------------ |
| delete  | 删除的悬空符号链接    |
| convert | 成功转换为相对路径的链接 |
| skip    | 未修改的链接       |

### skip 的计算方式

```text
skip = total_links - delete - convert
```

> 不为 skip 创建文件，减少 I/O 开销

---

### 输出示例

```text
1198 / 1198 [====================] 100%

统计结果:
  删除悬空链接: 87
  转换为相对路径: 643
  跳过未修改: 468
  合计: 1198
```

---

## dry-run 语义

当使用 `--dry-run`：

* **不会** 实际执行 `rm` / `ln`
* **会** 输出等价的命令
* **仍然参与统计**

  * delete = “本应删除的数量”
  * convert = “本应转换的数量”

这使得 dry-run 非常适合：

* 预估影响范围
* CI / 审计

---

## 依赖说明

### 必需

* `bash >= 4`
* `find`
* `readlink`
* `xargs`

### 可选（推荐）

| 工具         | 用途               |
| ---------- | ---------------- |
| `pv`       | 进度条              |
| `realpath` | 相对路径计算           |
| `python3`  | `realpath` 的备用方案 |

---

## 性能建议

| 场景        | 推荐 `--jobs` |
| --------- | ----------- |
| SSD / 本地盘 | `nproc`     |
| HDD       | `4 ~ 8`     |
| NFS / 网络盘 | `2 ~ 4`     |

---

## 设计取舍说明

### 为什么不用 flock 计数？

* 文件打点统计更简单
* 不引入锁竞争
* 中断后统计仍可信

### 为什么不用 GNU parallel？

* `xargs` 默认可用
* 无额外依赖
* 更容易在嵌入式 / build 环境使用

---

## 适用 / 不适用场景

### ✅ 适用

* rootfs / sysroot 重定位
* SDK 打包
* 容器镜像清洗
* CI 自动修复

### ❌ 不适用

* 需要保留“系统根 `/` 语义”的链接
* 符号链接指向动态生成路径的系统

---

## 许可与安全性

* 只在 `ROOT_DIR` 内操作
* 不跟随链接写入其他路径
* 不修改普通文件 / 目录

---

## 总结

`rootfs-rltv-cnv` 是一个：

* **语义明确**
* **并行高效**
* **可预演**
* **统计可审计**

的工程级符号链接修复工具，适合在生产构建流程中使用。
